<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>TBK Gem by sagmor</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">TBK Gem</h1>
        <p class="header">Pure Ruby implementation of Transbank's Webpay protocol</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/sagmor/tbk/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/sagmor/tbk/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/sagmor/tbk">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/sagmor">sagmor</a></p>


      </header>
      <section>
        <h3>
<a name="about" class="anchor" href="#about"><span class="octicon octicon-link"></span></a>About</h3>

<p><a href="http://badge.fury.io/rb/tbk"><img src="https://badge.fury.io/rb/tbk.png" alt="Gem Version"></a>
<a href="https://travis-ci.org/sagmor/tbk"><img src="https://travis-ci.org/sagmor/tbk.png" alt="Build Status"></a>
<a href="https://codeclimate.com/github/sagmor/tbk"><img src="https://codeclimate.com/github/sagmor/tbk.png" alt="Code Climate"></a></p>

<p>This is a pure ruby replacement of Transbank's Binary Integration Kit (aka. KCC)
developed to simplify the integration with it's payment gateway Webpay.</p>

<h3>
<a name="disclaimer" class="anchor" href="#disclaimer"><span class="octicon octicon-link"></span></a>Disclaimer</h3>

<p>This library is not developed, supported nor endorsed in any way by Transbank S.A.
and is the result of reverse engineering Transbank's Integration Kit (aka. KCC)
for interoperability purposes as allowed by
<a href="http://www.leychile.cl/Navegar?idNorma=1012827">Chilean Law 20.435 Article 71 Ã‘ Section b</a></p>

<h3>
<a name="usage" class="anchor" href="#usage"><span class="octicon octicon-link"></span></a>Usage</h3>

<p>Add this line to your application's Gemfile:</p>

<div class="highlight highlight-ruby"><pre><span class="n">gem</span> <span class="s1">'tbk'</span>
</pre></div>

<p>Configure your commerce</p>

<div class="highlight highlight-ruby"><pre><span class="no">TBK</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="o">.</span><span class="n">commerce_id</span> <span class="no">YOUR_COMMERCE_ID</span>
  <span class="n">config</span><span class="o">.</span><span class="n">commerce_key</span> <span class="no">YOUR_RSA_KEY</span>
<span class="k">end</span>
</pre></div>

<p>To start a payment from your application</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">WebpayController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="c1"># ...</span>

  <span class="c1"># Start a payment</span>
  <span class="k">def</span> <span class="nf">pay</span>
    <span class="c1"># Setup the payment</span>
    <span class="vi">@payment</span> <span class="o">=</span> <span class="ss">TBK</span><span class="p">:</span><span class="ss">:Webpay</span><span class="o">::</span><span class="no">Payment</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>
      <span class="ss">amount</span><span class="p">:</span> <span class="no">ORDER_AMOUNT</span><span class="p">,</span>
      <span class="n">order_id</span><span class="p">:</span> <span class="no">ORDER_ID</span><span class="p">,</span>
      <span class="n">success_url</span><span class="p">:</span> <span class="n">webpay_success_url</span><span class="p">,</span>
      <span class="c1"># Webpay can only access the HTTP protocol to a direct IP address (keep that in mind)</span>
      <span class="n">confirmation_url</span><span class="p">:</span> <span class="n">webpay_confirmation_url</span><span class="p">(</span><span class="ss">host</span><span class="p">:</span> <span class="no">SERVER_IP_ADDRESS</span><span class="p">,</span> <span class="ss">protocol</span><span class="p">:</span> <span class="s1">'http'</span><span class="p">),</span>

      <span class="c1"># Optionaly supply:</span>
      <span class="n">session_id</span><span class="p">:</span> <span class="no">SOME_SESSION_VALUE</span><span class="p">,</span>
      <span class="n">failure_url</span><span class="p">:</span> <span class="n">webpay_failure_url</span> <span class="c1"># success_url is used by default</span>
    <span class="p">})</span>

    <span class="c1"># Redirect the user to Webpay</span>
    <span class="n">redirect_to</span> <span class="vi">@payment</span><span class="o">.</span><span class="n">redirect_url</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span>
</pre></div>

<p>And to process a payment</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">WebpayController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="c1"># ...</span>

  <span class="c1"># Confirmation callback executed from Webpay servers</span>
  <span class="k">def</span> <span class="nf">confirmation</span>
    <span class="c1"># Read the confirmation data from the request</span>
    <span class="vi">@confirmation</span> <span class="o">=</span> <span class="ss">TBK</span><span class="p">:</span><span class="ss">:Webpay</span><span class="o">::</span><span class="no">Confirmation</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">raw_post</span><span class="p">)</span>

    <span class="k">if</span> <span class="c1"># confirmation is invalid for some reason (wrong order_id or amount, double payment, etc...)</span>
      <span class="n">render</span> <span class="ss">text</span><span class="p">:</span> <span class="vi">@confirmation</span><span class="o">.</span><span class="n">reject</span>
      <span class="k">return</span> <span class="c1"># reject and stop execution</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="vi">@confirmation</span><span class="o">.</span><span class="n">success?</span>
      <span class="c1"># EXITO!</span>
      <span class="c1"># perform everything you have to do here.</span>
    <span class="k">end</span>

    <span class="c1"># Acknowledge payment</span>
    <span class="n">render</span> <span class="ss">text</span><span class="p">:</span> <span class="vi">@confirmation</span><span class="o">.</span><span class="n">acknowledge</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>

<span class="k">end</span>
</pre></div>

<h3>
<a name="contributing" class="anchor" href="#contributing"><span class="octicon octicon-link"></span></a>Contributing</h3>

<ol>
<li>Fork it</li>
<li>Create your feature branch (<code>git checkout -b my-new-feature</code>)</li>
<li>Commit your changes (<code>git commit -am 'Add some feature'</code>)</li>
<li>Push to the branch (<code>git push origin my-new-feature</code>)</li>
<li>Create new Pull Request</li>
</ol>
      </section>
      <footer>
        <p><small>Hosted on <a href="https://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		          <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-18659564-2");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>